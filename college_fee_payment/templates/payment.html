<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Payment – PBR VITS</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f6f8;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: auto;
        }

        .card {
            background: #fff;
            border: 1px solid #ccc;
            padding: 20px;
            margin-bottom: 20px;
        }

        .payment-grid {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .payment-box {
            width: 220px;
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 15px;
            text-align: center;
        }

        .payment-box img {
            width: 40px;
        }

        .click-btn {
            background: #f4d03f;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
        }

        .hidden {
            display: none
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .next-btn {
            margin-top: 20px;
            background: #f4d03f;
            border: none;
            padding: 10px 40px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
        }

        .note {
            margin-top: 15px;
            font-size: 14px;
            color: #555;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                max-width: 100%;
            }

            .card {
                padding: 15px;
            }

            .payment-grid {
                gap: 15px;
            }

            .payment-box {
                width: calc(50% - 10px);
                min-width: 140px;
                padding: 12px;
            }

            .payment-box img {
                width: 35px;
            }

            .payment-box p {
                font-size: 14px;
            }

            .click-btn {
                padding: 6px 12px;
                font-size: 13px;
            }

            .summary-row {
                font-size: 14px;
                flex-wrap: wrap;
            }

            .next-btn {
                padding: 12px 20px;
                font-size: 16px;
            }

            .note {
                font-size: 13px;
            }

            #qrCodeContainer img {
                width: 180px !important;
            }
        }
    </style>
</head>

<body>
    <div class="container">

        <!-- PAYMENT OPTIONS -->
        <div class="card">
            <h3>Select Payment Mode</h3>

            <div class="payment-grid">
                <div class="payment-box">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/c/cc/SBI-logo.svg">
                    <p><b>SBI Net Banking</b></p>
                    <button class="click-btn" onclick="showDetails('SBI Net Banking')">Click Here</button>
                </div>

                <div class="payment-box">
                    <img src="https://cdn-icons-png.flaticon.com/512/196/196578.png">
                    <p><b>Credit Card</b></p>
                    <button class="click-btn" onclick="showDetails('Credit Card')">Click Here</button>
                </div>

                <div class="payment-box">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/e/e1/UPI-Logo-vector.svg">
                    <p><b>UPI</b></p>
                    <button class="click-btn" onclick="showDetails('UPI')">Click Here</button>
                </div>

                <div class="payment-box">
                    <img src="https://img.icons8.com/fluency/48/bank-building.png">
                    <p><b>Branch</b></p>
                    <button class="click-btn" onclick="showDetails('Branch')">Click Here</button>
                </div>
            </div>
        </div>

        <!-- PAYMENT DETAILS -->
        <div class="card hidden" id="paymentDetails">
            <h3>Payment Details</h3>

            <div class="summary-row">
                <span>Fee Type</span>
                <span id="feeType">COLLEGE FEE</span>
            </div>

            <div class="summary-row">
                <span>Amount</span>
                <span>₹ <span id="amount">{{ amount }}</span></span>
            </div>

            <div class="summary-row">
                <span>Payment Mode</span>
                <span id="modeDisplay"></span>
            </div>

            <p class="note" id="message"></p>

            <div id="qrCodeContainer" style="text-align: center; display: none; margin-top: 15px;">
                <p style="margin-bottom: 10px;"><b>Scan to Pay</b></p>
                <img src="{{ url_for('static', filename='qr_code.jpg') }}" alt="Payment QR Code"
                    style="width: 200px; border: 1px solid #ccc;">
            </div>

            <form id="paymentForm" action="{{ url_for('payment') }}" method="POST">
                <input type="hidden" name="mode" id="modeInput">
                <button type="button" id="nextBtn" class="next-btn" onclick="submitPayment()">NEXT</button>
            </form>
        </div>

    </div>

    <!-- TIMEOUT MODAL -->
    <div id="timeoutModal" class="modal">
        <div class="modal-content">
            <div style="font-size: 50px; color: red; margin-bottom: 20px;">⚠</div>
            <h2>Request Timed Out</h2>
            <p>Your session has expired.</p>
            <button class="btn close-btn" onclick="location.reload()">Back</button>
        </div>
    </div>

    <!-- SUCCESS MODAL -->
    <div id="successModal" class="modal">
        <div class="modal-content">
            <div style="font-size: 50px; color: green; margin-bottom: 20px;">✓</div>
            <h2>Payment Successful!</h2>
            <p>Your transaction has been completed successfully.</p>
            <button class="btn print" onclick="submitPayment()">Next</button>
        </div>
    </div>

    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #fff;
            padding: 40px;
            border-radius: 10px;
            text-align: center;
            width: 400px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            animation: fadeIn 0.4s;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
        }

        .print {
            background: #f4d03f;
        }

        .close-btn {
            background: #ccc;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }
    </style>

    <script>
        let timerInterval;
        let pollingInterval;
        const REF_ID = "{{ ref }}"; // Injected from Flask

        function showDetails(mode) {
            document.getElementById("paymentDetails").classList.remove("hidden");
            document.getElementById("modeDisplay").innerText = mode;
            document.getElementById("modeInput").value = mode;

            const qrContainer = document.getElementById("qrCodeContainer");
            const timerDisplay = document.getElementById("timerDisplay");
            const nextBtn = document.getElementById("nextBtn");
            const msgElement = document.getElementById("message");

            let msg = "";

            // Reset UI state
            qrContainer.style.display = "none";
            clearInterval(timerInterval);
            clearInterval(pollingInterval);
            if (timerDisplay) timerDisplay.remove();

            // Default state: Button enabled (unless UPI)
            nextBtn.disabled = false;
            nextBtn.style.background = "#f4d03f";
            nextBtn.innerText = "NEXT";

            if (mode === "SBI Net Banking") {
                msg = "You will be redirected to SBI login page.";
            } else if (mode === "Credit Card") {
                msg = "You will be redirected to secure card payment gateway.";
            } else if (mode === "UPI") {
                msg = "Please scan the QR code below using your UPI app.";
                qrContainer.style.display = "block";

                // Add Timer Display
                const timerDiv = document.createElement("div");
                timerDiv.id = "timerDisplay";
                timerDiv.style.fontSize = "24px";
                timerDiv.style.fontWeight = "bold";
                timerDiv.style.color = "#d32f2f";
                timerDiv.style.margin = "10px 0";
                timerDiv.innerText = "Time Remaining: 12:00";
                qrContainer.appendChild(timerDiv);

                // DISABLE NEXT BUTTON INITIALLY
                nextBtn.disabled = true;
                nextBtn.style.background = "#ccc";

                // Start Expiry Timer (12 mins)
                startTimer(12 * 60, timerDiv, nextBtn);

                // START POLLING FOR REAL-TIME STATUS
                startPolling();

            } else if (mode === "Branch") {
                msg = "Please visit SBI branch with the reference number.";
            }

            msgElement.innerText = msg;
        }

        function startTimer(duration, display, btn) {
            let timer = duration, minutes, seconds;
            timerInterval = setInterval(function () {
                minutes = parseInt(timer / 60, 10);
                seconds = parseInt(timer % 60, 10);

                minutes = minutes < 10 ? "0" + minutes : minutes;
                seconds = seconds < 10 ? "0" + seconds : seconds;

                display.innerText = "Time Remaining: " + minutes + ":" + seconds;

                if (--timer < 0) {
                    clearInterval(timerInterval);
                    clearInterval(pollingInterval); // Stop polling on timeout

                    document.getElementById("timeoutModal").style.display = "flex";
                }
            }, 1000);
        }

        function startPolling() {
            if (!REF_ID) return;
            pollingInterval = setInterval(() => {
                fetch("/check_status/" + REF_ID)
                    .then(response => response.json())
                    .then(data => {
                        console.log("Payment Status:", data.status);
                        if (data.status === "SUCCESS") {
                            clearInterval(pollingInterval);
                            clearInterval(timerInterval); // Stop countdown
                            document.getElementById("successModal").style.display = "flex";
                        }
                    })
                    .catch(e => console.error("Polling Error:", e));
            }, 2000); // Check every 2 seconds
        }

        function submitPayment() {
            document.getElementById("paymentForm").submit();
        }
    </script>

</body>

</html>